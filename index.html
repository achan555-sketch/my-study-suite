<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÄ GRX Pro: Real-Timeframe v20 üéÄ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Roboto+Mono:wght@500;700&display=swap');
        :root { 
            --p-light: #ffe5ec; --p-main: #ff8fab; --p-dark: #fb6f92; --bg: #0d0d0d; --card: #1a1a1a;
            --up: #ff3131; --down: #00e676; --text: #ffffff;
            --gold: #ffd700;
        }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Quicksand', sans-serif; color: var(--text); }
        
        /* Start & Victory Overlays */
        #start-overlay, #victory-overlay { position: fixed; inset: 0; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #start-overlay { background: #fff0f3; color: #5c4d50; }
        #victory-overlay { background: rgba(0,0,0,0.85); display: none; }
        .input-name { padding: 15px; border-radius: 15px; border: 3px solid var(--p-light); width: 300px; font-size: 1.3rem; text-align: center; margin-bottom: 20px; outline: none; }
        .start-btn { background: var(--p-dark); color: white; border: none; padding: 12px 50px; border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 1.3rem; }
        .victory-card { background: linear-gradient(135deg, #fff, #fff0f3); color: #333; padding: 40px; border-radius: 30px; text-align: center; border: 4px solid var(--gold); box-shadow: 0 0 60px var(--gold); }

        /* Main Layout */
        .main-container { display: flex; width: 100vw; height: 100vh; padding: 10px; box-sizing: border-box; gap: 10px; }
        .left-panel { flex: 0 0 50%; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; }
        .chart-box { background: #000; border-radius: 12px; padding: 8px; border: 1px solid #333; position: relative; aspect-ratio: 1/1; }
        .chart-label { color: #888; font-size: 0.6rem; font-weight: bold; position: absolute; top: 8px; left: 10px; z-index: 5; }
        canvas { width: 100%; height: 100%; }

        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        .card { background: var(--card); border-radius: 15px; padding: 10px; border: 1px solid #333; }
        
        .stats-card { display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--p-main); }
        .total-asset { font-size: 1.4rem; font-weight: 700; color: var(--p-main); font-family: 'Roboto Mono'; }

        .board-card { background: #000; font-family: 'Roboto Mono'; flex-grow: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; border: 2px solid #222; border-radius: 15px; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 0 10px; scrollbar-width: none; }
        .board-row { display: flex; justify-content: space-between; height: 18px; align-items: center; font-size: 0.8rem; }
        .ask-price { color: var(--up); font-weight: bold; }
        .bid-price { color: var(--down); font-weight: bold; }
        .mid-price-line { background: #1a1a1a; text-align: center; padding: 5px; border-top: 1px solid #333; border-bottom: 1px solid #333; margin: 4px 0; font-weight: bold; font-size: 1.1rem; }

        .trade-card { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn { border: none; padding: 10px; border-radius: 10px; font-weight: 700; cursor: pointer; color: white; font-family: 'Quicksand'; font-size: 0.85rem; }
        .btn-buy { background: var(--up); }
        .btn-sell { background: var(--down); }

        .ranking-card { font-size: 0.75rem; background: #0a0a0a; border-radius: 15px; height: 140px; overflow-y: auto; flex-shrink: 0; }
        .rank-row { display: flex; justify-content: space-between; padding: 4px 12px; border-bottom: 1px solid #111; }
        .rank-row.me { color: var(--p-main); font-weight: bold; background: rgba(255, 143, 171, 0.1); }
    </style>
</head>
<body>

<div id="start-overlay">
    <span style="font-size:3rem;">üéÄ</span>
    <h1>GLOBAL RIBBON EXCHANGE</h1>
    <input type="text" id="user-name-input" class="input-name" placeholder="Trader Name" maxlength="10">
    <button class="start-btn" onclick="startGame()">ENTER MARKET üöÄ</button>
</div>

<div id="victory-overlay" onclick="this.style.display='none'">
    <div class="victory-card">
        <h1 style="color:var(--p-dark); margin:0;">üëë WORLD NO.1 üëë</h1>
        <p style="font-size:1.2rem; font-weight:bold;">Mars Traveler Surrendered!</p>
        <p><span id="winner-name"></span> is the new Legend.</p>
        <button class="start-btn" style="margin-top:20px; font-size:1rem;">CONTINUE TRADING</button>
    </div>
</div>

<div class="main-container">
    <div class="left-panel">
        <div class="chart-box"><span class="chart-label">1M (NOW)</span><canvas id="chart1m"></canvas></div>
        <div class="chart-box"><span class="chart-label">5M (SHORT)</span><canvas id="chart5m"></canvas></div>
        <div class="chart-box"><span class="chart-label">DAILY (STATIC)</span><canvas id="chartDaily"></canvas></div>
        <div class="chart-box"><span class="chart-label">WEEKLY (STATIC)</span><canvas id="chartWeekly"></canvas></div>
    </div>

    <div class="right-panel">
        <div class="card stats-card">
            <div><div id="player-name" style="font-size:0.6rem; opacity:0.6;">TRADER: achan</div><div class="total-asset"><span id="total-val">100,000.0</span> <small style="font-size:0.6rem;">GRB</small></div></div>
            <div id="rank-display" style="font-size: 0.75rem; font-weight: bold; color: gold;">#?? WORLD</div>
        </div>

        <div class="card board-card">
            <div class="scroll-area">
                <div id="ask-rows"></div><div class="mid-price-line" id="mid-val-display">100.0</div><div id="bid-rows"></div>
            </div>
        </div>

        <div class="card trade-card">
            <button class="btn btn-buy" onclick="trade('buy', 1)">BUY 1</button>
            <button class="btn btn-sell" id="s1" onclick="trade('sell', 1)">SELL 1</button>
            <button class="btn btn-buy" style="opacity:0.8" onclick="trade('buy','max')">ALL IN</button>
            <button class="btn btn-sell" id="smax" style="opacity:0.8" onclick="trade('sell','max')">EXIT ALL</button>
            <div style="grid-column: span 2; font-size:0.65rem; display:flex; justify-content:space-between; opacity:0.6; font-family:'Roboto Mono';">
                <span>CASH: <span id="cash-val">100.0k</span></span><span>HOLD: <span id="hold-val">0</span></span>
            </div>
        </div>

        <div class="card ranking-card">
            <div style="padding:8px 12px; color:var(--p-main); font-weight:700; font-size:0.7rem; border-bottom:1px solid #222;">üåç WORLD PARODY RANKING</div>
            <div id="ranking-list"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    let userName = "achan", price = 100.0, lastPrice = 100.0, MIN = 70.0, MAX = 130.0;
    let user = { cash: 100000.0, hold: 0 }, hasWon = false;
    
    // Data Arrays
    let data1m = [], data5m = [], dataDaily = [], dataWeekly = [];
    
    // Simulation Counters & Temp Candles
    let tickCount = 0;
    let candle1m = { o:price, h:price, l:price, c:price };
    let candle5m = { o:price, h:price, l:price, c:price };

    const worldTraders = [
        {n: "Mars Traveler üöÄ", a: 21000000}, {n: "Warren Buffet üç∞", a: 15000000}, {n: "Jeff Amazo üì¶", a: 12000000},
        {n: "Jensen AI ü§ñ", a: 8000000}, {n: "Zuck Meta üë•", a: 6000000}, {n: "Bill Windows üíª", a: 5000000},
        {n: "Ribbon Oracle üîÆ", a: 4000000}, {n: "Giraffe Queen ü¶í", a: 3500000}, {n: "Toppan Elite üè¢", a: 2500000},
        {n: "USCPA Fighter üá∫üá∏", a: 1800000}, {n: "Daytrade Cat üê±", a: 950000}, {n: "Whale Watching üê≥", a: 800000},
        {n: "Diamond Hands üíé", a: 600000}, {n: "Coffee Addict ‚òï", a: 400000}, {n: "Smart AI ü¶æ", a: 150000}
    ];

    function preGenerateData() {
        let p = price;
        for(let i=0; i<40; i++) {
            p = Math.max(MIN, Math.min(MAX, p + (Math.random()-0.5)*3));
            let c = {o:p, h:p+0.5, l:p-0.5, c:p};
            // Fill all initially to look populated
            data1m.push(c); if(i%5===0) data5m.push(c); if(i%20===0) dataDaily.push(c); if(i%40===0) dataWeekly.push(c);
        }
        price = p;
        candle1m = { o:price, h:price, l:price, c:price };
        candle5m = { o:price, h:price, l:price, c:price };
    }

    function startGame() {
        userName = document.getElementById('user-name-input').value || "Trader";
        document.getElementById('player-name').innerText = `TRADER: ${userName}`;
        document.getElementById('start-overlay').style.display = 'none';
        preGenerateData();
        setInterval(updateMarket, 600); // 600ms per tick
    }

    function updateMarket() {
        lastPrice = price;
        price = Math.max(MIN, Math.min(MAX, price + (Math.random()-0.5)*3));
        tickCount++;

        // Update 1M forming candle
        candle1m.h = Math.max(candle1m.h, price); candle1m.l = Math.min(candle1m.l, price); candle1m.c = price;

        // Every 5 ticks = 1M candle finished
        if (tickCount % 5 === 0) {
            data1m.push({...candle1m}); if(data1m.length>30) data1m.shift();
            // Update 5M forming candle based on finished 1M
            candle5m.h = Math.max(candle5m.h, candle1m.h); candle5m.l = Math.min(candle5m.l, candle1m.l); candle5m.c = candle1m.c;
            if(tickCount === 5) candle5m.o = candle1m.o; // Set open for the first 1M part
            candle1m = { o:price, h:price, l:price, c:price }; // Reset 1M
        }

        // Every 25 ticks = 5M candle finished
        if (tickCount % 25 === 0) {
            data5m.push({...candle5m}); if(data5m.length>30) data5m.shift();
            candle5m = { o:price, h:price, l:price, c:price }; // Reset 5M
            tickCount = 0;
        }
        // Daily/Weekly do NOT update here (static background)

        drawAllCharts(); drawBoard(); updateUI();
    }

    function drawCandles(id, data, formingCandle = null) {
        const c = document.getElementById(id); const ctx = c.getContext('2d');
        const w = c.width = c.offsetWidth * 2; const h = c.height = c.offsetHeight * 2;
        ctx.scale(2,2); const cw = w/2, ch = h/2; ctx.clearRect(0,0,cw,ch);
        const drawData = [...data]; if(formingCandle) drawData.push(formingCandle); // Add forming candle temporarily
        
        const space = cw / 32, getY = (val) => ch - ((val - 68) / (132 - 68)) * ch;
        drawData.forEach((d, i) => {
            const x = i * space + space, up = d.c >= d.o, color = up ? '#ff3131' : '#00e676';
            ctx.strokeStyle = color; ctx.lineWidth = 1.2;
            ctx.beginPath(); ctx.moveTo(x, getY(d.h)); ctx.lineTo(x, getY(d.l)); ctx.stroke();
            ctx.fillStyle = color;
            const rectY = getY(Math.max(d.o, d.c)), rectH = Math.max(2, Math.abs(getY(d.o) - getY(d.c)));
            ctx.fillRect(x - 3, rectY, 6, rectH);
        });
    }

    function drawAllCharts() {
        // Pass forming candles to 1M and 5M charts
        drawCandles('chart1m', data1m, candle1m);
        drawCandles('chart5m', data5m, candle5m);
        // Daily/Weekly only draw historical data
        drawCandles('chartDaily', dataDaily);
        drawCandles('chartWeekly', dataWeekly);
    }

    function drawBoard() {
        const askA = document.getElementById('ask-rows'), bidA = document.getElementById('bid-rows'), midA = document.getElementById('mid-val-display');
        let askH = '', bidH = '';
        for(let i=10; i>=1; i--) askH += `<div class="board-row"><span class="ask-price">${(price + i*0.1).toFixed(1)}</span><span style="color:#444">${Math.floor(Math.random()*900+50)}</span></div>`;
        for(let i=1; i<=10; i++) bidH += `<div class="board-row"><span class="bid-price">${(price - i*0.1).toFixed(1)}</span><span style="color:#444">${Math.floor(Math.random()*900+50)}</span></div>`;
        askA.innerHTML = askH; bidA.innerHTML = bidH;
        midA.innerText = price.toFixed(1); midA.style.color = price >= lastPrice ? 'var(--up)' : 'var(--down)';
    }

    function trade(type, amt) {
        let qty = (amt === 'max') ? (type === 'buy' ? Math.floor(user.cash / price) : user.hold) : amt;
        if (type === 'buy' && user.cash >= price * qty && qty > 0) { user.cash -= price * qty; user.hold += qty; }
        else if (type === 'sell' && user.hold >= qty && qty > 0) { user.hold -= qty; user.cash += price * qty; }
        updateUI();
    }

    function updateUI() {
        const total = user.cash + (user.hold * price);
        document.getElementById('total-val').innerText = total.toLocaleString(undefined, {minimumFractionDigits: 1});
        document.getElementById('cash-val').innerText = (user.cash/1000).toFixed(1) + 'k';
        document.getElementById('hold-val').innerText = user.hold;
        const allTraders = [...worldTraders, {n: userName, a: total, me: true}].sort((a,b) => b.a - a.a);
        const myRank = allTraders.findIndex(t => t.me) + 1;
        document.getElementById('rank-display').innerText = `#${myRank} WORLD`;

        if (myRank === 1 && !hasWon) {
            hasWon = true;
            document.getElementById('victory-overlay').style.display = 'flex';
            document.getElementById('winner-name').innerText = userName;
            confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 }, colors: ['#ffd700', '#ff8fab', '#ffffff'] });
        }
        let listH = ''; allTraders.forEach((l, i) => { listH += `<div class="rank-row ${l.me?'me':''}"><span>${i+1}. ${l.n}</span><span>${Math.floor(l.a).toLocaleString()}</span></div>`; });
        document.getElementById('ranking-list').innerHTML = listH;
        document.getElementById('s1').disabled = user.hold < 1; document.getElementById('smax').disabled = user.hold < 1;
    }
</script>
</body>
</html>
